/*
** GARANTIA POR EQUIPAMENTO
*/

SET TERM !;

ALTER TABLE CLI_EQUIP ADD GARANTIA SIMNAO!

UPDATE CLI_EQUIP SET GARANTIA = 'N'!

CREATE DOMAIN DATADIA_VALIDA AS DATE NOT NULL!

CREATE DOMAIN DATADIA AS DATE!

ALTER TABLE CLI_EQUIP ADD DATAINI DATADIA!

ALTER TABLE CLI_EQUIP ADD DATAFIM DATADIA!

CREATE EXCEPTION GARANTIA_PRAZO 'SE FOR GARANTIA, PRAZO DEVE SER INFORMADO'!

ALTER TRIGGER CLI_EQUIP_BI0
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  
  /* SE FOR GARANTIA, DEVE ESPECIFICAR O PRAZO */
  IF (((NEW.DATAINI IS NULL) OR (NEW.DATAFIM IS NULL)) AND (NEW.GARANTIA = 'S')) THEN
    EXCEPTION GARANTIA_PRAZO;

  /* VERIFICO O ULTIMO E OBTENHO O NOVO CODIGO */
  SELECT
    MAX(CODEQUIPAMENTO) + 1
  FROM
    CLI_EQUIP
  WHERE
    CODCLIENTE = NEW.CODCLIENTE
  INTO
    NEW.CODEQUIPAMENTO;
    
  IF (NEW.CODEQUIPAMENTO IS NULL) THEN
    NEW.CODEQUIPAMENTO = 1;

END!

CREATE TRIGGER CLI_EQUIP_BU0 FOR CLI_EQUIP
ACTIVE BEFORE UPDATE POSITION 0
AS
begin

  /* SE FOR GARANTIA, DEVE ESPECIFICAR O PRAZO */
  IF (((NEW.DATAINI IS NULL) OR (NEW.DATAFIM IS NULL)) AND (NEW.GARANTIA = 'S')) THEN
    EXCEPTION GARANTIA_PRAZO;

end!

INSERT INTO SEQUENCIA(CODIGO, TABELA, SEQUENCIA) VALUES(40, 'CARTAS', 1)!

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (114, CURRENT_TIMESTAMP)!