/*
** CORRECAO NA CONSTRUCAO DOS PLANOS DE CONTAS
*/

SET TERM ^ ;

ALTER TRIGGER PLANCONTAS_BI0
ACTIVE BEFORE INSERT POSITION 0
AS
DECLARE VARIABLE CONTADOR INTEGER;
BEGIN

  /* VERIFICO SE EH RAIZ OU DESCENDENTE */
  IF (NEW.CODPAI = -1) THEN
   BEGIN

     /* RAIZ */
     NEW.CODPLANO = '';

   END ELSE
   BEGIN

     /* DESCENDENTE */
     SELECT
       CODPLANO
     FROM
       PLANCONTAS
     WHERE
       CODIGO = NEW.CODPAI
     INTO
       NEW.CODPLANO;

     NEW.CODPLANO = UDF_TRIM(NEW.CODPLANO) || '.';

   END

  /* LIMITO O TAMANHO DO PLANO */
  IF (UDF_LEN(UDF_TRIM(NEW.CODPLANO)) > 16) THEN
    EXCEPTION PLANO_GRANDE;

  SELECT
    MAX(UDF_RIGHT(UDF_TRIM(CODPLANO), 2))
  FROM
    PLANCONTAS
  WHERE
    CODPAI = NEW.CODPAI
  INTO
    :CONTADOR;

  IF (CONTADOR IS NULL) THEN
    CONTADOR = 0;

  IF (CONTADOR = 0) THEN
    CONTADOR = 1;
  ELSE
    CONTADOR = CONTADOR + 1;

  NEW.CODPLANO = UDF_TRIM(NEW.CODPLANO) || UDF_PADL(CAST
(CONTADOR AS VARCHAR(2)), '0', 2);

END

^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (158, CURRENT_TIMESTAMP);
COMMIT;
