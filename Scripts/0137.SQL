/*
** REGISTRO DE ATIVACAO E REBATE
*/

SET TERM !;

ALTER TABLE INDIVIDUAIS ADD NUMERO_FONE  STR20!
ALTER TABLE INDIVIDUAIS ADD CODOPERADORA INTEIRO!
ALTER TABLE INDIVIDUAIS ADD CODPLANO     INTEIRO!
ALTER TABLE INDIVIDUAIS ADD REBATE       SIMNAO!
ALTER TABLE INDIVIDUAIS ADD ATIVACAO     SIMNAO!
ALTER TABLE INDIVIDUAIS ADD CODINDIVIDUO INTEIRO!
ALTER TABLE INDIVIDUAIS ADD APARELO      STR60!
    
ALTER TABLE INDIVIDUAIS ADD 
  CONSTRAINT     INDIVIDUAIS_FK04
  FOREIGN KEY    (CODOPERADORA)
  REFERENCES     OPERADORAS(CODIGO)
  ON UPDATE CASCADE!
  
ALTER TABLE INDIVIDUAIS ADD 
  CONSTRAINT     INDIVIDUAIS_FK05
  FOREIGN KEY    (CODPLANO, CODOPERADORA)
  REFERENCES     PLANOS(CODIGO, CODOPERADORA)
  ON UPDATE CASCADE!
   
ALTER TABLE PRODUTOS ADD ATIVACAO SIMNAO!

ALTER PROCEDURE INFOVENDA (
    BARRA CHAR(14),
    CODEMPRESA INTEGER)
RETURNS (
    CODIGO INTEGER,
    QUANTIDADE INTEGER,
    DESCRICAO VARCHAR(100),
    ICMS NUMERIC(9,2),
    VALOR NUMERIC(9,2),
    CODSERVICO INTEGER)
AS
DECLARE VARIABLE CODPRODUTO INTEGER;
DECLARE VARIABLE UNICO INTEGER;
DECLARE VARIABLE NUMSERIE CHAR(20);
DECLARE VARIABLE PS CHAR(1);
DECLARE VARIABLE ICMSSIMPLES CHAR(1);
DECLARE VARIABLE ALIQUOTA_ICMSSIMPLES NUMERIC(9,4);
BEGIN

  /* PEGO DADOS INICIAIS */
  SELECT
    CODIGO,
    PS,
    DESCRICAO,
    PRECOVENDA
  FROM
    PRODUTOS
  WHERE
    BARRA = :BARRA
  INTO
    :CODIGO,
    :PS,
    :DESCRICAO,
    :VALOR;

  /* SE FOR SERVIÇO */
  if (PS = 'S') then
   begin
     ICMS = 0;
     QUANTIDADE = 9999;
     SUSPEND;
     EXIT;
   end

  /* EXISTE MESMO? */
  SELECT
    COUNT(*)
  FROM
    INDIVIDUAIS
  WHERE
    BARRA = :BARRA AND
    VENDIDO = 'N' AND
    CODEMPRESA = :CODEMPRESA
  INTO
    :CODIGO;

  IF (CODIGO IS NULL) THEN
    CODIGO = 0;

  IF (CODIGO = 0) THEN
     EXCEPTION ITEM_ERRADO;

  /* SE EXISTIR, RETORNO */
  FOR
  SELECT
    INDIVIDUAIS.CODIGO,
    INDIVIDUAIS.CODPRODUTO,
    INDIVIDUAIS.UNICO,
    INDIVIDUAIS.SERIE,
    PRODUTOS.PRECOVENDA,
    PRODUTOS.ICMS,
    PRODUTOS.DESCRICAO,
    PRODUTOS.CODSERVICO
  FROM
    INDIVIDUAIS
    JOIN PRODUTOS ON
      (INDIVIDUAIS.CODPRODUTO = PRODUTOS.CODIGO)
  WHERE
    INDIVIDUAIS.BARRA = :BARRA AND
    INDIVIDUAIS.VENDIDO = 'N' AND
    INDIVIDUAIS.CODPRODUTO = PRODUTOS.CODIGO AND
    INDIVIDUAIS.CODEMPRESA = :CODEMPRESA
  INTO
    :CODIGO,
    :CODPRODUTO,
    :UNICO,
    :NUMSERIE,
    :VALOR,
    :ICMS,
    :DESCRICAO,
    :CODSERVICO
  DO
  BEGIN

    /* SE FOR INDIVIDUAL, RETORNO SOMENTE ELE */
    IF (UNICO = 1) THEN
     BEGIN

       IF (NUMSERIE IS NOT NULL) THEN
         DESCRICAO = DESCRICAO || ' - ' || NUMSERIE;

       QUANTIDADE = 1;

     END ELSE
     BEGIN

       /* SE FOR NORMAL, SOMO A QUANTIDADE */
       SELECT
         SUM(QUANTIDADE)
       FROM
         INDIVIDUAIS
       WHERE
         BARRA = :BARRA AND
         VENDIDO = 'N'
       INTO
         :QUANTIDADE;

     END

    /* VERIFICO SE O ICMS EH SIMPLES OU NAO */
    SELECT
      ICMSSIMPLES,
      ALIQUOTA_ICMSSIMPLES
    FROM
      SISCONFIG
    WHERE
      CODIGO = :CODEMPRESA
    INTO
      :ICMSSIMPLES,
      :ALIQUOTA_ICMSSIMPLES;

    IF (ICMSSIMPLES = 'S') THEN
      ICMS = CAST(ALIQUOTA_ICMSSIMPLES AS NUMERIC(9, 2));

    SUSPEND;
    EXIT;

  END
END!

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (137, CURRENT_TIMESTAMP)!