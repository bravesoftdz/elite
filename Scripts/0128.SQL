/*
** CODIGO DO CLIENTE NOS PAGAMENTOS
*/

SET TERM !;

ALTER TABLE PAGAMENTOS ADD CODCLIENTE INTEIRO_VALIDO!

ALTER TRIGGER PAGAMENTOS_BU0 INACTIVE!

CREATE PROCEDURE PREENCHE_CLIENTE 
AS
DECLARE VARIABLE CODCLIENTE INTEGER;
DECLARE VARIABLE CODIGO INTEGER;
DECLARE VARIABLE CODEMPRESA INTEGER;
DECLARE VARIABLE CODMOVIMENTO INTEGER;
begin

  /* TODOS OS PAGAMENTOS */
  FOR
  SELECT
    PA.CODIGO,
    PA.CODEMPRESA,
    PA.CODMOVIMENTO
  FROM
    PAGAMENTOS PA
  ORDER BY
    CODIGO
  INTO
    :CODIGO,
    :CODEMPRESA,
    :CODMOVIMENTO
  DO
  BEGIN

    IF (CODMOVIMENTO IS NULL) THEN
     BEGIN

       /* OBTENHO O CONSUMIDOR */
       SELECT
         SI.CODCLIENTE_PADRAO
       FROM
         SISCONFIG SI
       WHERE
         SI.CODIGO = :CODEMPRESA
       INTO
         :CODCLIENTE;

     END ELSE
     BEGIN

       /* OBTENHO O CLIENTE DO MOVIMENTO */
       SELECT
         MO.CODCLIENTE
       FROM
         MOVIMENTOS MO
       WHERE
         CODIGO = :CODMOVIMENTO
       INTO
         :CODCLIENTE;

     END

    /* ATUALIZO O PAGAMENTO */
    UPDATE
      PAGAMENTOS
    SET
      CODCLIENTE = :CODCLIENTE
    WHERE
      CODIGO = :CODIGO;

  END

end!

EXECUTE PROCEDURE PREENCHE_CLIENTE!

ALTER TRIGGER PAGAMENTOS_BU0 ACTIVE!

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (128, CURRENT_TIMESTAMP)!