SET TERM ^ ;

CREATE PROCEDURE CALC_ICMS (
    CODMOVIMENTO INTEGER)
RETURNS (
    VALOR_ICMS NUMERIC(9,2))
AS
BEGIN
  SELECT
    SUM(VALOR_ICMS)
  FROM
    INDIVIDUAIS
  WHERE
    CODMOVSAIDA = :CODMOVIMENTO
  INTO
    :VALOR_ICMS;
  IF (VALOR_ICMS IS NULL) THEN
    VALOR_ICMS = 0;
  SUSPEND;
END
^

SET TERM ; ^

GRANT EXECUTE ON PROCEDURE CALC_ICMS TO PUBLIC;

SET TERM ^ ;

ALTER TRIGGER STATUS_UPDATE
ACTIVE BEFORE UPDATE POSITION 0
AS
BEGIN
   IF (NEW.TIPO = 0) THEN NEW.STATUS = 'ORÇAMENTO';
   IF (NEW.TIPO = 1) THEN NEW.STATUS = 'COMPRA';
   IF (NEW.TIPO = 2) THEN NEW.STATUS = 'OS ABERTA';
   IF (NEW.TIPO = 3) THEN NEW.STATUS = 'OS FECHADA';
   IF (NEW.TIPO = 4) THEN NEW.STATUS = 'PRE ASSITENCIA';
   IF (NEW.TIPO = 5) THEN NEW.STATUS = 'VENDA ABERTA';
   IF (NEW.TIPO = 6) THEN NEW.STATUS = 'VENDA FECHADA';
   IF (NEW.TIPO = 7) THEN NEW.STATUS = 'N/F';
   IF (NEW.TIPO = 8) THEN NEW.STATUS = 'N/F';
   IF (NEW.TIPO = 9) THEN NEW.STATUS = 'ESTORNO';

   /* TOTAL ICMS */
   SELECT
     VALOR_ICMS
   FROM
     CALC_ICMS(NEW.CODIGO)
   INTO
     NEW.VALOR_ICMS;

   /* FECHOU A VENDA */
   IF ((OLD.TIPO IN (2, 5)) AND (NEW.TIPO IN (3, 6))) THEN
    BEGIN

      /* USUÁRIO, DATA E HORA DO FECHAMENTO */
      NEW.DATAFECHAMENTO = 'NOW';
      NEW.USUARIOFECHAMENTO = USER;

      /* TOTAL DA COMISSAO */
      SELECT
        SUM(VALOR_COMISSAO)
      FROM
        INDIVIDUAIS
      WHERE
        CODMOVSAIDA = OLD.CODIGO AND
        VENDIDO = 'S'
      INTO
        NEW.VALOR_COMISSAO;

      IF (NEW.VALOR_COMISSAO IS NULL) THEN
        NEW.VALOR_COMISSAO = 0.0;

      /* CALCULAR IMPOSTOS */
      IF ((NEW.NOTA_NUMERO IS NULL) AND (NEW.ECF = 'N')) THEN
         NEW.VALOR_ICMS = 0;

    END

   /* RATEIO DOS CUSTOS DE COMPRA */
   IF ((NEW.ES = 1) AND (NEW.TIPO = 1)) THEN
     EXECUTE PROCEDURE RATEIO_CUSTOS (
       NEW.CODIGO,
       NEW.VALOR_PRODUTOS,
       NEW.VALOR_RATEIO_CUSTO);

END

^

SET TERM ; ^

