/*
** NOVA ANALISE DE DATAS
*/

SET TERM ^ ;

ALTER PROCEDURE ANALISE_DATA (
    DATA TIMESTAMP)
RETURNS (
    DATA_FLUXO TIMESTAMP,
    DIA_FLUXO INTEGER,
    SEMANA_FLUXO INTEGER,
    MES_FLUXO INTEGER,
    BIMESTRE_FLUXO INTEGER,
    TRIMESTRE_FLUXO INTEGER,
    QUADRIMESTRE_FLUXO INTEGER,
    SEMESTRE_FLUXO INTEGER,
    ANO_FLUXO INTEGER,
    STR_SEMANA_FLUXO VARCHAR(30),
    STR_MES_FLUXO VARCHAR(20),
    STR_BIMESTRE_FLUXO VARCHAR(30),
    STR_TRIMESTRE_FLUXO VARCHAR(30),
    STR_QUADRIMESTRE_FLUXO VARCHAR(30),
    STR_SEMESTRE_FLUXO VARCHAR(30))
AS
DECLARE VARIABLE TEMP_SEMANA INTEGER;
DECLARE VARIABLE TEMP_DATA TIMESTAMP;
BEGIN

  /* DATA FLUXO */
  DATA_FLUXO = DATA;

  /* SE FOR SABADO, SOMO 1 DIA  */
  IF (UDF_WEEKDAY(DATA_FLUXO) = 6) THEN
    DATA_FLUXO = DATA_FLUXO + 1;

  /* SE FOR DOMINGO, SOMO 1 DIA  PARA CAIR NA PROXIMA SEGUNDA */
  IF (UDF_WEEKDAY(DATA_FLUXO) = 0) THEN
    DATA_FLUXO = DATA_FLUXO + 1;

  /* DIA FLUXO */
  DIA_FLUXO = EXTRACT(DAY FROM DATA_FLUXO);

  /* SEMANA FLUXO */
  /* DIA DA SEMANA DO PRIMEIRO DIA DO ANO */
  TEMP_DATA = UDF_ENCDATE(
      EXTRACT(YEAR FROM DATA_FLUXO),
      01,
      01);
  TEMP_SEMANA = UDF_WEEKDAY(TEMP_DATA);
  /* SE FOR DOMINGO OU SEGUNDA A SEMANA COMEÇA MAIS TARDE */
  IF (TEMP_SEMANA > 0) THEN
   BEGIN
     IF (TEMP_SEMANA = 6) THEN
       TEMP_DATA = TEMP_DATA + 1;
     ELSE
       TEMP_DATA = TEMP_DATA - TEMP_SEMANA;
   END
  /* DIFERENÇA ENTRE AS SEMANAS */
  SEMANA_FLUXO = CAST((DATA_FLUXO - TEMP_DATA) AS INTEGER) / 7;
  IF (SEMANA_FLUXO = 0) THEN
    SEMANA_FLUXO = 1;
  ELSE
    IF (UDF_MOD(CAST((DATA_FLUXO - TEMP_DATA) AS INTEGER), 7) > 0) THEN
      SEMANA_FLUXO = SEMANA_FLUXO + 1;

  /* MES */
  MES_FLUXO = EXTRACT(MONTH FROM DATA_FLUXO);

  /* BIMESTRE FLUXO */
  BIMESTRE_FLUXO = CAST((MES_FLUXO / 2) AS INTEGER);
  IF (BIMESTRE_FLUXO = 0) THEN
    BIMESTRE_FLUXO = 1;
  ELSE
    IF (UDF_MOD(MES_FLUXO, 2) > 0) THEN
      BIMESTRE_FLUXO = BIMESTRE_FLUXO + 1;

  /* TRIMESTRE FLUXO */
  TRIMESTRE_FLUXO = CAST((MES_FLUXO / 3) AS INTEGER);
  IF (TRIMESTRE_FLUXO = 0) THEN
    TRIMESTRE_FLUXO = 1;
  ELSE
    IF (UDF_MOD(MES_FLUXO, 3) > 0) THEN
      TRIMESTRE_FLUXO = TRIMESTRE_FLUXO + 1;

  /* QUADRIMESTRE FLUXO */
  QUADRIMESTRE_FLUXO = CAST((MES_FLUXO / 4) AS INTEGER);
  IF (QUADRIMESTRE_FLUXO = 0) THEN
    QUADRIMESTRE_FLUXO = 1;
  ELSE
    IF (UDF_MOD(MES_FLUXO, 4) > 0) THEN
      QUADRIMESTRE_FLUXO = QUADRIMESTRE_FLUXO + 1;

  /* SEMESTRE FLUXO */
  SEMESTRE_FLUXO = CAST((MES_FLUXO / 6) AS INTEGER);
  IF (SEMESTRE_FLUXO = 0) THEN
    QUADRIMESTRE_FLUXO = 1;
  ELSE
    IF (UDF_MOD(MES_FLUXO, 6) > 0) THEN
      SEMESTRE_FLUXO = SEMESTRE_FLUXO + 1;

  /* ANO FLUXO */
  ANO_FLUXO = EXTRACT(YEAR FROM DATA_FLUXO);

  /* STR SEMANA */
  TEMP_SEMANA = UDF_WEEKDAY(DATA_FLUXO);
  TEMP_DATA = DATA_FLUXO - TEMP_SEMANA;
  STR_SEMANA_FLUXO = UDF_PADL(EXTRACT(DAY FROM TEMP_DATA), '0', 2) || '/' ||
    UDF_PADL(EXTRACT(MONTH FROM TEMP_DATA), '0', 2) || '/' ||
    EXTRACT(YEAR FROM TEMP_DATA);
  TEMP_DATA = TEMP_DATA + 6;
  STR_SEMANA_FLUXO = STR_SEMANA_FLUXO || ' - ' ||
    UDF_PADL(EXTRACT(DAY FROM TEMP_DATA), '0', 2) || '/' ||
    UDF_PADL(EXTRACT(MONTH FROM TEMP_DATA), '0', 2) || '/' ||
    EXTRACT(YEAR FROM TEMP_DATA);

  /* STR MES */
  IF (MES_FLUXO = 1) THEN
    STR_MES_FLUXO = 'JANEIRO';
  ELSE IF (MES_FLUXO = 2) THEN
    STR_MES_FLUXO = 'FEVEREIRO';
  ELSE IF (MES_FLUXO = 3) THEN
    STR_MES_FLUXO = 'MARÇO';
  ELSE IF (MES_FLUXO = 4) THEN
    STR_MES_FLUXO = 'ABRIL';
  ELSE IF (MES_FLUXO = 5) THEN
    STR_MES_FLUXO = 'MAIO';
  ELSE IF (MES_FLUXO = 6) THEN
    STR_MES_FLUXO = 'JUNHO';
  ELSE IF (MES_FLUXO = 7) THEN
    STR_MES_FLUXO = 'JULHO';
  ELSE IF (MES_FLUXO = 8) THEN
    STR_MES_FLUXO = 'AGOSTO';
  ELSE IF (MES_FLUXO = 9) THEN
    STR_MES_FLUXO = 'SETEMBRO';
  ELSE IF (MES_FLUXO = 10) THEN
    STR_MES_FLUXO = 'OUTUBRO';
  ELSE IF (MES_FLUXO = 11) THEN
    STR_MES_FLUXO = 'NOVEMBRO';
  ELSE IF (MES_FLUXO = 12) THEN
    STR_MES_FLUXO = 'DEZEMBRO';

  /* STR BIMESTRE */
  IF (BIMESTRE_FLUXO = 1) THEN
    STR_BIMESTRE_FLUXO = 'JANEIRO - FEVEREIRO';
  ELSE IF (BIMESTRE_FLUXO = 2) THEN
    STR_BIMESTRE_FLUXO = 'MARÇO - ABRIL';
  ELSE IF (BIMESTRE_FLUXO = 3) THEN
    STR_BIMESTRE_FLUXO = 'MAIO - JUNHO';
  ELSE IF (BIMESTRE_FLUXO = 4) THEN
    STR_BIMESTRE_FLUXO = 'JULHO - AGOSTO';
  ELSE IF (BIMESTRE_FLUXO = 5) THEN
    STR_BIMESTRE_FLUXO = 'SETEMBRO - OUTUBRO';
  ELSE IF (BIMESTRE_FLUXO = 6) THEN
    STR_BIMESTRE_FLUXO = 'NOVEMBRO - DEZEMBRO';

  /* STR TRIMESTRE */
  IF (TRIMESTRE_FLUXO = 1) THEN
    STR_TRIMESTRE_FLUXO = 'JANEIRO - MARÇO';
  ELSE IF (TRIMESTRE_FLUXO = 2) THEN
    STR_TRIMESTRE_FLUXO = 'ABRIL - JUNHO';
  ELSE IF (TRIMESTRE_FLUXO = 3) THEN
    STR_TRIMESTRE_FLUXO = 'JULHO - SETEMBRO';
  ELSE IF (TRIMESTRE_FLUXO = 2) THEN
    STR_TRIMESTRE_FLUXO = 'OUTUBRO - DEZEMBRO';

  /* STR QUADRIMESTRE */
  IF (QUADRIMESTRE_FLUXO = 1) THEN
    STR_QUADRIMESTRE_FLUXO = 'JANEIRO - ABRIL';
  ELSE IF (QUADRIMESTRE_FLUXO = 2) THEN
    STR_QUADRIMESTRE_FLUXO = 'MAIO - AGOSTO';
  ELSE IF (QUADRIMESTRE_FLUXO = 3) THEN
    STR_QUADRIMESTRE_FLUXO = 'SETEMBRO - DEZEMBRO';

  /* STR SEMESTRE */
  IF (SEMESTRE_FLUXO = 1) THEN
    STR_SEMESTRE_FLUXO = 'JANEIRO - JUNHO';
  ELSE IF (SEMESTRE_FLUXO = 2) THEN
    STR_SEMESTRE_FLUXO = 'JULHO - DEZEMBRO';

  SUSPEND;

END

^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (156, CURRENT_TIMESTAMP);
COMMIT;