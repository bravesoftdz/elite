/*
** FIM DA MARGEM EM CAMPO CALCULADO - O RETORNO!!!
*/

SET TERM !;

ALTER TRIGGER PROVAR_UPD
ACTIVE AFTER UPDATE POSITION 10
AS
   DECLARE VARIABLE NOVO     NUMERIC(9,2);
   DECLARE VARIABLE ANTIGO   NUMERIC(9,2);
   DECLARE VARIABLE REAJUSTE NUMERIC(9,2);
BEGIN

   /* PEGO OS VALORES */
   NOVO   = NEW.PRECOVENDA;
   ANTIGO = OLD.PRECOVENDA;

   /* HOUVE ALGUM REAJUSTE? */
   IF (NOVO <> ANTIGO) THEN
    BEGIN

      IF (NOVO > ANTIGO) THEN
       BEGIN

         /* REAJUSTE PARA MAIS */
         IF (ANTIGO = 0) THEN
            REAJUSTE = NOVO * 100;
         ELSE
            REAJUSTE = (100 - ((NOVO * 100) / ANTIGO)) * -1;

       END ELSE
       BEGIN

         /* REAJUSTE PARA MENOS */
         IF (NOVO = 0) THEN
            REAJUSTE = ANTIGO * -100;
         ELSE
            REAJUSTE = (100 - ((ANTIGO * 100) / NOVO));

       END


      INSERT INTO
        VARIACAO_VALOR (
          CODPRODUTO,
          VALOR_ANTIGO,
          VALOR_NOVO,
          REAJUSTE )
        VALUES (
          OLD.CODIGO,
          :ANTIGO,
          :NOVO,
          :REAJUSTE );

    END

END!

ALTER TRIGGER PROVAR_UPD
ACTIVE AFTER UPDATE POSITION 10
AS
   DECLARE VARIABLE REAJUSTE NUMERIC(9,4);
BEGIN

   /* HOUVE ALGUM REAJUSTE? */
   IF (NEW.PRECOVENDA <> OLD.PRECOVENDA) THEN
    BEGIN

      IF (NEW.PRECOVENDA > OLD.PRECOVENDA) THEN
       BEGIN

         IF (OLD.PRECOVENDA = 0) THEN
            REAJUSTE = NEW.PRECOVENDA * 100;
         ELSE
            REAJUSTE = ((NEW.PRECOVENDA * 100) / OLD.PRECOVENDA) - 100;

       END ELSE
       BEGIN

         IF (NEW.PRECOVENDA = 0) THEN
            REAJUSTE = OLD.PRECOVENDA * -100;
         ELSE
            REAJUSTE = ((OLD.PRECOVENDA - NEW.PRECOVENDA) * -100) / OLD.PRECOVENDA;

       END

      INSERT INTO
        VARIACAO_VALOR (
          CODPRODUTO,
          DATA,
          VALOR_ANTIGO,
          VALOR_NOVO,
          REAJUSTE )
        VALUES (
          OLD.CODIGO,
          CURRENT_TIMESTAMP,
          OLD.PRECOVENDA,
          NEW.PRECOVENDA,
          :REAJUSTE);

    END

END!

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (123, CURRENT_TIMESTAMP)!