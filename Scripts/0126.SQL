/*
** ANALISE DE DATAS
*/

SET TERM !;

CREATE PROCEDURE ANALISE_DATA (
    DATA TIMESTAMP)
RETURNS (
    DATA_FLUXO TIMESTAMP,
    DIA_FLUXO INTEGER,
    SEMANA_FLUXO INTEGER,
    MES_FLUXO INTEGER,
    BIMESTRE_FLUXO INTEGER,
    TRIMESTRE_FLUXO INTEGER,
    QUADRIMESTRE_FLUXO INTEGER,
    SEMESTRE_FLUXO INTEGER,
    ANO_FLUXO INTEGER)
AS
DECLARE VARIABLE TEMP_SEMANA INTEGER;
DECLARE VARIABLE TEMP_DATA TIMESTAMP;
BEGIN

  /* DATA FLUXO */
  DATA_FLUXO = DATA;

  /* SE FOR SABADO, SOMO 1 DIA  */
  IF (UDF_WEEKDAY(DATA_FLUXO) = 6) THEN
    DATA_FLUXO = DATA_FLUXO + 1;

  /* SE FOR DOMINGO, SOMO 1 DIA  PARA CAIR NA PROXIMA SEGUNDA */
  IF (UDF_WEEKDAY(DATA_FLUXO) = 0) THEN
    DATA_FLUXO = DATA_FLUXO + 1;

  /* DIA FLUXO */
  DIA_FLUXO = EXTRACT(DAY FROM DATA_FLUXO);

  /* SEMANA FLUXO */
  /* DIA DA SEMANA DO PRIMEIRO DIA DO ANO */
  TEMP_DATA = UDF_ENCDATE(
      EXTRACT(YEAR FROM DATA_FLUXO),
      01,
      01);
  TEMP_SEMANA = UDF_WEEKDAY(TEMP_DATA);
  /* SE FOR DOMINGO OU SEGUNDA A SEMANA COMEÇA MAIS TARDE */
  IF (TEMP_SEMANA > 0) THEN
   BEGIN
     IF (TEMP_SEMANA = 6) THEN
       TEMP_DATA = TEMP_DATA + 1;
     ELSE
       TEMP_DATA = TEMP_DATA - TEMP_SEMANA;
   END
  /* DIFERENÇA ENTRE AS SEMANAS */
  SEMANA_FLUXO = CAST((DATA_FLUXO - TEMP_DATA) AS INTEGER) / 7;
  IF (SEMANA_FLUXO = 0) THEN
    SEMANA_FLUXO = 1;
  ELSE
    IF (UDF_MOD(CAST((DATA_FLUXO - TEMP_DATA) AS INTEGER), 7) > 0) THEN
      SEMANA_FLUXO = SEMANA_FLUXO + 1;

  /* MES */
  MES_FLUXO = EXTRACT(MONTH FROM DATA_FLUXO);

  /* BIMESTRE FLUXO */
  BIMESTRE_FLUXO = CAST((MES_FLUXO / 2) AS INTEGER);
  IF (BIMESTRE_FLUXO = 0) THEN
    BIMESTRE_FLUXO = 1;
  ELSE
    IF (UDF_MOD(MES_FLUXO, 2) > 0) THEN
      BIMESTRE_FLUXO = BIMESTRE_FLUXO + 1;

  /* TRIMESTRE FLUXO */
  TRIMESTRE_FLUXO = CAST((MES_FLUXO / 3) AS INTEGER);
  IF (TRIMESTRE_FLUXO = 0) THEN
    TRIMESTRE_FLUXO = 1;
  ELSE
    IF (UDF_MOD(MES_FLUXO, 3) > 0) THEN
      TRIMESTRE_FLUXO = TRIMESTRE_FLUXO + 1;

  /* QUADRIMESTRE FLUXO */
  QUADRIMESTRE_FLUXO = CAST((MES_FLUXO / 4) AS INTEGER);
  IF (QUADRIMESTRE_FLUXO = 0) THEN
    QUADRIMESTRE_FLUXO = 1;
  ELSE
    IF (UDF_MOD(MES_FLUXO, 4) > 0) THEN
      QUADRIMESTRE_FLUXO = QUADRIMESTRE_FLUXO + 1;

  /* SEMESTRE FLUXO */
  SEMESTRE_FLUXO = CAST((MES_FLUXO / 6) AS INTEGER);
  IF (SEMESTRE_FLUXO = 0) THEN
    QUADRIMESTRE_FLUXO = 1;
  ELSE
    IF (UDF_MOD(MES_FLUXO, 6) > 0) THEN
      SEMESTRE_FLUXO = SEMESTRE_FLUXO + 1;

  /* ANO FLUXO */
  ANO_FLUXO = EXTRACT(YEAR FROM DATA_FLUXO);

  SUSPEND;

END!

GRANT EXECUTE ON PROCEDURE ANALISE_DATA TO PUBLIC!
 
INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (126, CURRENT_TIMESTAMP)!