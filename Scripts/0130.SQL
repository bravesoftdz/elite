/*
** VALOR DO SERVIÇO AGREGADO AO PRODUTO
*/

SET TERM !;

ALTER TABLE PRODUTOS ADD PRECOSERVICO DINHEIRO!
ALTER TABLE PRODUTOS ADD PRECOTOTAL   DINHEIRO!

ALTER TRIGGER VERIFICA_BARRA_UPD  INACTIVE!
ALTER TRIGGER PRODUTOS_MARGEM_UPD INACTIVE!
ALTER TRIGGER PROVAR_UPD          INACTIVE!

CREATE PROCEDURE PREENCHE_PRECO 
AS
DECLARE VARIABLE CODIGO INTEGER;
DECLARE VARIABLE CODSERVICO INTEGER;
DECLARE VARIABLE PRECOVENDA NUMERIC(9,2);
DECLARE VARIABLE PRECOSERVICO NUMERIC(9,2);
DECLARE VARIABLE PRECOTOTAL NUMERIC(9,2);
begin

  FOR
  SELECT
    CODIGO,
    PRECOVENDA,
    CODSERVICO
  FROM
    PRODUTOS
  WHERE
    PS = 'P'
  INTO
    :CODIGO,
    :PRECOVENDA,
    :CODSERVICO
  DO
  BEGIN

    IF (CODSERVICO IS NOT NULL) THEN
     BEGIN

       SELECT
         PRECOVENDA
       FROM
         PRODUTOS
       WHERE
         CODIGO = :CODSERVICO AND
         PS = 'S'
       INTO
         :PRECOSERVICO;

       PRECOTOTAL = PRECOVENDA + PRECOSERVICO;

     END ELSE
     BEGIN

       PRECOSERVICO = 0;
       PRECOTOTAL   = PRECOVENDA;

     END


    UPDATE
      PRODUTOS
    SET
      PRECOSERVICO = :PRECOSERVICO,
      PRECOTOTAL   = :PRECOTOTAL
    WHERE
      CODIGO       = :CODIGO;

  END

END!

EXECUTE PROCEDURE PREENCHE_PRECO!

ALTER TRIGGER VERIFICA_BARRA_UPD  ACTIVE!
ALTER TRIGGER PRODUTOS_MARGEM_UPD ACTIVE!
ALTER TRIGGER PROVAR_UPD          ACTIVE!

COMMIT!

DROP PROCEDURE PREENCHE_PRECO!

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (130, CURRENT_TIMESTAMP)!