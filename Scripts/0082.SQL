/*
** NOME DE FAMILIA
*/

ALTER TABLE CLIENTES ADD NOME_FAMILIA STR50!

CREATE PROCEDURE FAMILIA(
   ENTRADA VARCHAR(50)) 
RETURNS (
   SAIDA VARCHAR(50))
AS
  DECLARE VARIABLE TAMANHO INTEGER;
  DECLARE VARIABLE POSICAO INTEGER;
BEGIN

  /* SAIDA NULA */
  SAIDA = '';

  /* PROCURO O SOBRENOME */
  ENTRADA = F_LRTRIM(ENTRADA);
  TAMANHO = F_STRINGLENGTH(ENTRADA);
  POSICAO = TAMANHO - 1;
  WHILE ((POSICAO > -1) AND (F_MID(ENTRADA, POSICAO, 1) <> ' ')) DO
    POSICAO = POSICAO - 1;

  /* VERIFICO A SAIDA */
  IF (POSICAO > -1) THEN
   BEGIN

    /* SEPARO O SOBRENOME */
    SAIDA = F_MID(ENTRADA, POSICAO + 1,
       F_STRINGLENGTH(ENTRADA) - POSICAO -1);
    SAIDA = SAIDA || ', ';

    /* RESTANTE DO NOME */
    SAIDA = SAIDA || F_MID(ENTRADA, 0, POSICAO);

   END ELSE SAIDA = ENTRADA;

  SUSPEND;

END!

GRANT EXECUTE ON PROCEDURE FAMILIA TO PUBLIC!

CREATE TRIGGER CLIENTE_FAMILIA_INSERT FOR CLIENTES
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  /* NOME DE FAMILIA */
  IF (NEW.PESSOAFISICA = 'F') THEN
     EXECUTE PROCEDURE FAMILIA(NEW.NOME)
       RETURNING_VALUES NEW.NOME_FAMILIA;
  ELSE
     NEW.NOME_FAMILIA = NEW.NOME;
END!

CREATE TRIGGER CLIENTE_FAMILIA_UPDATE FOR CLIENTES
ACTIVE BEFORE UPDATE POSITION 0
AS
BEGIN
  /* NOME DE FAMILIA */
  IF (NEW.PESSOAFISICA = 'F') THEN
     EXECUTE PROCEDURE FAMILIA(NEW.NOME)
       RETURNING_VALUES NEW.NOME_FAMILIA;
  ELSE
     NEW.NOME_FAMILIA = NEW.NOME;
END!

CREATE PROCEDURE PREENCHE_FAMILIA 
AS
DECLARE VARIABLE CODIGO INTEGER;
DECLARE VARIABLE NOME VARCHAR(50);
DECLARE VARIABLE PESSOAFISICA CHAR(1);
DECLARE VARIABLE NOVO VARCHAR(50);
BEGIN
  /* PROCEDURE TEXT */
  FOR
  SELECT
    CODIGO,
    NOME,
    PESSOAFISICA
  FROM
    CLIENTES
  ORDER BY
    CODIGO
  INTO
    :CODIGO,
    :NOME,
    :PESSOAFISICA
  DO
  BEGIN

    NOME = F_LRTRIM(NOME);
    EXECUTE PROCEDURE FAMILIA(:NOME)
      RETURNING_VALUES :NOVO;

    IF (PESSOAFISICA = 'F') THEN
      NOME = NOVO;

    UPDATE
      CLIENTES
    SET
      NOME_FAMILIA = :NOME
    WHERE
      CODIGO = :CODIGO;

  END

END!

EXECUTE PROCEDURE PREENCHE_FAMILIA!

DROP PROCEDURE PREENCHE_FAMILIA!

CREATE INDEX CLIENTES_NOME_FAMILIA ON CLIENTES(NOME_FAMILIA)!

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (82, CURRENT_TIMESTAMP)!
