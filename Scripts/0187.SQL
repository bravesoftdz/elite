/*
** BUG NA TROCA DE SENHA
*/

SET TERM ^ ;

ALTER PROCEDURE TROCA_SENHAWEB (
    CODUSUARIO INTEGER,
    SENHAATUAL VARCHAR(10),
    SENHANOVA VARCHAR(10),
    SENHACONFIRMACAO VARCHAR(10),
    MAQUINA VARCHAR(30),
    DATAHORAREMOTO TIMESTAMP)
RETURNS (
    RESULTADO INTEGER)
AS
DECLARE VARIABLE TEMP_ATUAL VARCHAR(10);
DECLARE VARIABLE TEMP_USUARIO VARCHAR(30);
begin

  /* RESULTADO EH ERRADO POR DEFAULT */
  RESULTADO = 1;

  IF (SENHAATUAL IS NULL) THEN
    SENHAATUAL = '';

  IF (SENHANOVA IS NULL) THEN
    SENHANOVA = '';

  IF (SENHACONFIRMACAO IS NULL) THEN
    SENHACONFIRMACAO = '';

  /* LEIO A SENHA ATUAL */
  SELECT
    SENHAWEB,
    NOMEUSER
  FROM
    CLIENTES
  WHERE
    CODIGO = :CODUSUARIO
  INTO
    :TEMP_ATUAL,
    :TEMP_USUARIO;

  IF (TEMP_ATUAL IS NULL) THEN
    TEMP_ATUAL = '';

  /* SENHA ATUAL BATE? */
  IF (TEMP_ATUAL = SENHAATUAL) THEN
   BEGIN

     /* AS SENHAS NOVAS CONFEREM? */
     IF (SENHANOVA = SENHACONFIRMACAO) THEN
      BEGIN

        /* ATUALIZO A SENHA */
        UPDATE
          CLIENTES
        SET
          SENHAWEB       = :SENHANOVA,
          LOG_USUARIO    = :TEMP_USUARIO,
          LOG_MAQUINA    = :MAQUINA,
          LOG_DATAREMOTO = CURRENT_TIMESTAMP
        WHERE
          CODIGO = :CODUSUARIO;

        RESULTADO = 0;

        WHEN ANY DO RESULTADO = 1;

      END ELSE RESULTADO = 1;

   END ELSE RESULTADO = 1;

end

^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (187, CURRENT_TIMESTAMP);
COMMIT;