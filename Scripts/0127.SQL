/*
** CONDICAO DE PAGAMENTO PADRONIZADA
*/

SET TERM !;

CREATE TABLE CONDPAG (
   CODIGO         INTEIRO_VALIDO,
   DESCRICAO      STR40_VALIDO,
   CONDICAO       STR40_VALIDO,
   QUANTIDADE     INTEIRO,
   PRAZOMEDIO     INTEIRO,
   TAXAJUROS      PORCENTO,
   CONSTRAINT     CONDPAG_PK
   PRIMARY KEY    (CODIGO)
)!

GRANT ALL ON CONDPAG TO PUBLIC!

CREATE UNIQUE INDEX CONDPAG_UI01 ON CONDPAG (DESCRICAO)!

INSERT INTO
  SEQUENCIA(
    CODIGO,
    TABELA,
    SEQUENCIA)
  VALUES(
    42,
    'CONDPAG',
    1)!
    
ALTER TABLE CONDPAG ADD CODDOC_AVISTA INTEIRO!

ALTER TABLE CONDPAG ADD CODDOC_PRAZO INTEIRO!

CREATE EXCEPTION AVISTA_SOMETEUM 'DEVE HAVER SOMENTE 1 PARCELA A VISTA'!

CREATE EXCEPTION FALTA_DOCAVISTA 'FALTA DOCUMENTO A VISTA'!

CREATE EXCEPTION FALTA_DOCPRAZO 'FALTA DOCUMENTO A PRAZO'!

CREATE TRIGGER CONDPAG_BI0 FOR CONDPAG
ACTIVE BEFORE INSERT POSITION 0
AS
DECLARE VARIABLE CONTADOR INTEGER;
BEGIN

  /* PREENCHO QUANTIDADE E PRAZO MEDIO */
  SELECT
    COUNT(DIAS),
    AVG(DIAS)
  FROM
    PARCELAS(NEW.CONDICAO)
  INTO
    NEW.QUANTIDADE,
    NEW.PRAZOMEDIO;

  /* EXISTE PARCELA A VISTA? */
  SELECT
    COUNT(*)
  FROM
    PARCELAS(NEW.CONDICAO)
  WHERE
    DIAS = 0
  INTO
    :CONTADOR;

  IF (CONTADOR IS NULL) THEN
    CONTADOR = 0;

  /* NAO PODE HAVER MAIS DE 1 A VISTA */
  IF (CONTADOR > 1) THEN
    EXCEPTION AVISTA_SOMETEUM;

  /* SE HOUVER 1 PARCELA, VERIFICO SE EH A VISTA */
  IF (CONTADOR = 1) THEN
   BEGIN

     /* VERIFICO SE O DOCUMENTO FOI PREENCHIDO */
     IF (NEW.CODDOC_AVISTA IS NULL) THEN
       EXCEPTION FALTA_DOCAVISTA;

     /* VERIFICO SE ELE EH MESMO A VISTA */
     SELECT
       COUNT(*)
     FROM
       DOCUMENTOS
     WHERE
       CODIGO = NEW.CODDOC_AVISTA AND
       TIPO_PAG = 'A'
     INTO
       :CONTADOR;

     IF (CONTADOR IS NULL) THEN
       CONTADOR = 0;

     IF (CONTADOR = 0) THEN
       EXCEPTION FALTA_DOCAVISTA;

   END

  /* EXISTE PARCELA A PRAZO? */
  SELECT
    COUNT(*)
  FROM
    PARCELAS(NEW.CONDICAO)
  WHERE
    DIAS > 0
  INTO
    :CONTADOR;

  IF (CONTADOR IS NULL) THEN
    CONTADOR = 0;

  /* SE HOUVER 1 OU MAIS PARCELAS, VERIFICO SE EH A PRAZO */
  IF (CONTADOR >= 1) THEN
   BEGIN

     /* VERIFICO SE O DOCUMENTO FOI PREENCHIDO */
     IF (NEW.CODDOC_PRAZO IS NULL) THEN
       EXCEPTION FALTA_DOCPRAZO;

     /* VERIFICO SE ELE EH MESMO A VISTA */
     SELECT
       COUNT(*)
     FROM
       DOCUMENTOS
     WHERE
       CODIGO = NEW.CODDOC_PRAZO AND
       TIPO_PAG = 'V'
     INTO
       :CONTADOR;

     IF (CONTADOR IS NULL) THEN
       CONTADOR = 0;

     IF (CONTADOR = 0) THEN
       EXCEPTION FALTA_DOCPRAZO;

   END

END!

CREATE TRIGGER CONDPAG_BU0 FOR CONDPAG
ACTIVE BEFORE UPDATE POSITION 0
AS
DECLARE VARIABLE CONTADOR INTEGER;
BEGIN

  /* PREENCHO QUANTIDADE E PRAZO MEDIO */
  SELECT
    COUNT(DIAS),
    AVG(DIAS)
  FROM
    PARCELAS(NEW.CONDICAO)
  INTO
    NEW.QUANTIDADE,
    NEW.PRAZOMEDIO;

  /* EXISTE PARCELA A VISTA? */
  SELECT
    COUNT(*)
  FROM
    PARCELAS(NEW.CONDICAO)
  WHERE
    DIAS = 0
  INTO
    :CONTADOR;

  IF (CONTADOR IS NULL) THEN
    CONTADOR = 0;

  /* NAO PODE HAVER MAIS DE 1 A VISTA */
  IF (CONTADOR > 1) THEN
    EXCEPTION AVISTA_SOMETEUM;

  /* SE HOUVER 1 PARCELA, VERIFICO SE EH A VISTA */
  IF (CONTADOR = 1) THEN
   BEGIN

     /* VERIFICO SE O DOCUMENTO FOI PREENCHIDO */
     IF (NEW.CODDOC_AVISTA IS NULL) THEN
       EXCEPTION FALTA_DOCAVISTA;

     /* VERIFICO SE ELE EH MESMO A VISTA */
     SELECT
       COUNT(*)
     FROM
       DOCUMENTOS
     WHERE
       CODIGO = NEW.CODDOC_AVISTA AND
       TIPO_PAG = 'A'
     INTO
       :CONTADOR;

     IF (CONTADOR IS NULL) THEN
       CONTADOR = 0;

     IF (CONTADOR = 0) THEN
       EXCEPTION FALTA_DOCAVISTA;

   END

  /* EXISTE PARCELA A PRAZO? */
  SELECT
    COUNT(*)
  FROM
    PARCELAS(NEW.CONDICAO)
  WHERE
    DIAS > 0
  INTO
    :CONTADOR;

  IF (CONTADOR IS NULL) THEN
    CONTADOR = 0;

  /* SE HOUVER 1 OU MAIS PARCELAS, VERIFICO SE EH A PRAZO */
  IF (CONTADOR >= 1) THEN
   BEGIN

     /* VERIFICO SE O DOCUMENTO FOI PREENCHIDO */
     IF (NEW.CODDOC_PRAZO IS NULL) THEN
       EXCEPTION FALTA_DOCPRAZO;

     /* VERIFICO SE ELE EH MESMO A VISTA */
     SELECT
       COUNT(*)
     FROM
       DOCUMENTOS
     WHERE
       CODIGO = NEW.CODDOC_PRAZO AND
       TIPO_PAG = 'V'
     INTO
       :CONTADOR;

     IF (CONTADOR IS NULL) THEN
       CONTADOR = 0;

     IF (CONTADOR = 0) THEN
       EXCEPTION FALTA_DOCPRAZO;

   END

END!

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (127, CURRENT_TIMESTAMP)!