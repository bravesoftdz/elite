/*
** PLANO DE CONTAS
*/

SET TERM !;

CREATE DOMAIN STR254 VARCHAR(254)!

CREATE DOMAIN TIPOPLANO CHAR(1) DEFAULT 'X' NOT NULL
  CHECK (VALUE IN ('C', 'D', 'X'))!

CREATE TABLE PLANCONTAS (
  CODIGO       INTEIRO_VALIDO,
  CODPAI       INTEIRO_VALIDO,
  CODPLANO     STR20_VALIDO,
  DESCRICAO    STR40_VALIDO,
  TIPO         TIPOPLANO,
  OBSERVACOES  STR254,
  CONSTRAINT   PLANCONTAS_PK
  PRIMARY KEY  (CODIGO)
)!

GRANT ALL ON PLANCONTAS TO PUBLIC!

CREATE UNIQUE INDEX PLANCONTAS_PLANO ON PLANCONTAS(CODPLANO)!

CREATE EXCEPTION PLANO_GRANDE 'O LIMITE DE DESCENDENTES DO PLANO FOI ATINGIDO'!

CREATE TRIGGER PLANCONTAS_BI0 FOR PLANCONTAS
ACTIVE BEFORE INSERT POSITION 0
AS
DECLARE VARIABLE CONTADOR INTEGER;
BEGIN

  /* VERIFICO SE EH RAIZ OU DESCENDENTE */
  IF (NEW.CODPAI = -1) THEN
   BEGIN

     /* RAIZ */
     NEW.CODPLANO = '';

   END ELSE
   BEGIN

     /* DESCENDENTE */
     SELECT
       CODPLANO
     FROM
       PLANCONTAS
     WHERE
       CODIGO = NEW.CODPAI
     INTO
       NEW.CODPLANO;

     NEW.CODPLANO = UDF_TRIM(NEW.CODPLANO) || '.';

   END

  /* LIMITO O TAMANHO DO PLANO */
  IF (UDF_LEN(UDF_TRIM(NEW.CODPLANO)) > 16) THEN
    EXCEPTION PLANO_GRANDE;

  SELECT
    COUNT(*)
  FROM
    PLANCONTAS
  WHERE
    CODPAI = NEW.CODPAI
  INTO
    :CONTADOR;

  IF (CONTADOR IS NULL) THEN
    CONTADOR = 0;

  IF (CONTADOR = 0) THEN
    CONTADOR = 1;
  ELSE
    CONTADOR = CONTADOR + 1;

  NEW.CODPLANO = UDF_TRIM(NEW.CODPLANO) || UDF_PADL(CAST(CONTADOR AS VARCHAR(2)), '0', 2);

END!

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (133, CURRENT_TIMESTAMP)!