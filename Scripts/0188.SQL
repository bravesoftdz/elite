/*
** NOVAS LOCALIDADES
*/

SET TERM ^ ;

CREATE PROCEDURE NOVA_LOCALIDADE (
    LOGRADOURO VARCHAR(50),
    BAIRRO VARCHAR(40),
    CEP VARCHAR(9),
    CODCIDADE INTEGER,
    CODESTADO VARCHAR(2))
RETURNS (
    CODLOGRADOURO INTEGER,
    CODBAIRRO INTEGER)
AS
begin

  /* VERIFICO SE O BAIRRO JA EXISTE */
  SELECT FIRST 1
    BAIRROS.CODIGO
  FROM
    BAIRROS
  WHERE
    BAIRROS.BAIRRO = UDF_TRIM(BAIRRO) AND
    BAIRROS.CIDADE = :CODCIDADE       AND
    BAIRROS.ESTADO = :CODESTADO
  INTO
    :CODBAIRRO;

  IF (CODBAIRRO IS NULL) THEN
   BEGIN

     /* SEQUENCIA DO CODIGO DO BAIRRO */
     EXECUTE PROCEDURE SEQ_OBTER('BAIRROS')
       RETURNING_VALUES CODBAIRRO;

     /* PRECISO CADASTRAR O BAIRRO */
     INSERT INTO
       BAIRROS (
         CODIGO,
         BAIRRO,
         CIDADE,
         ESTADO)
       VALUES (
         :CODBAIRRO,
         :BAIRRO,
         :CODCIDADE,
         :CODESTADO);

   END

  /* SEQUENCIA DO LOGRADOURO */
  EXECUTE PROCEDURE SEQ_OBTER('LOGRADOUROS')
    RETURNING_VALUES CODLOGRADOURO;

  /* GRAVO O NOVO LOGRADOURO */
  INSERT INTO
    LOGRADOUROS (
      CODIGO,
      LOGRADOURO,
      BAIRRO,
      CEP,
      CIDADE,
      ESTADO,
      EXTENSO)
    VALUES (
      :CODLOGRADOURO,
      :LOGRADOURO,
      :CODBAIRRO,
      :CEP,
      :CODCIDADE,
      :CODESTADO,
      :LOGRADOURO);

end

^

SET TERM ; ^

GRANT EXECUTE ON PROCEDURE NOVA_LOCALIDADE TO PUBLIC;

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (188, CURRENT_TIMESTAMP);
COMMIT;