/*
** EXTRATO COM DATA INICIAL E FINAL (POR PERIODO)
*/

SET TERM ^ ;

ALTER PROCEDURE EXTRATO (
    CODCONTA INTEGER,
    DATAINI DATE,
    DATAFIM DATE,
    CODEMPRESA INTEGER)
RETURNS (
    DATAHORA TIMESTAMP,
    USUARIO VARCHAR(30),
    DESCRICAO VARCHAR(40),
    VALORCRE NUMERIC(9,2),
    SALDO NUMERIC(9,2),
    LETRA CHAR(1),
    VALORDEB NUMERIC(9,2),
    INFODOC VARCHAR(50),
    DOCUMENTO VARCHAR(40),
    CLIENTE VARCHAR(40))
AS
DECLARE VARIABLE ES INTEGER;
DECLARE VARIABLE CONTADOR INTEGER;
DECLARE VARIABLE SALDOANT NUMERIC(9,2);
DECLARE VARIABLE CODDOCUMENTO INTEGER;
BEGIN
  /* PEGO O SALDO ANTERIOR */
  SELECT
    MAX(CODLANCTO)
  FROM
    PAGAMENTOS
  WHERE
    CAST(DATAPAGO AS DATE) < :DATAINI AND
    CODCONTA = :CODCONTA AND
    CODEMPRESA = :CODEMPRESA
  INTO
    :CONTADOR;
  SELECT
    SALDOATU
  FROM
    PAGAMENTOS
  WHERE
    CODLANCTO = :CONTADOR
  INTO
    :SALDOANT;
  DATAHORA = NULL;
  USUARIO = NULL;
  IF (SALDOANT IS NULL) THEN
     DESCRICAO = '*** ABERTURA DE CONTA ***';
  ELSE
     DESCRICAO = 'SALDO ANTERIOR TRANSPORTADO';
  CLIENTE = DESCRICAO;
  VALORCRE = NULL;
  VALORDEB = NULL;
  SALDO = SALDOANT;
  LETRA = NULL;
  SUSPEND;
  CONTADOR = 0;
  FOR
  SELECT
    PA.DATAPAGO,
    PA.NOMEUSUARIO,
    PA.DESCRICAO,
    PA.TOTAL_PAGO,
    PA.SALDOATU,
    PA.SALDOANT,
    PA.ES,
    PA.INFODOC,
    PA.CODDOCUMENTO,
    CL.NOME
  FROM
    PAGAMENTOS PA
    LEFT JOIN CLIENTES CL ON
      (CL.CODIGO = PA.CODCLIENTE)
  WHERE
    PA.CODCONTA = :CODCONTA AND
    PA.PAGO = 1 AND
    CAST(PA.DATAPAGO AS DATE) BETWEEN :DATAINI AND :DATAFIM AND
    PA.CODEMPRESA = :CODEMPRESA
  ORDER BY
    PA.CODLANCTO
  INTO
    :DATAHORA,
    :USUARIO,
    :DESCRICAO,
    :VALORCRE,
    :SALDO,
    :SALDOANT,
    :ES,
    :INFODOC,
    :CODDOCUMENTO,
    :CLIENTE
  DO
  BEGIN
    CONTADOR = CONTADOR + 1;
    IF (ES = 1) THEN
     BEGIN
      LETRA = 'D';
      VALORDEB = VALORCRE;
      VALORCRE = NULL;
     END
    ELSE
     BEGIN
      LETRA = 'C';
      VALORDEB = NULL;
     END
    SELECT
      DOCUMENTO
    FROM
      DOCUMENTOS
    WHERE
      CODIGO = :CODDOCUMENTO
    INTO
      :DOCUMENTO;
    SUSPEND;
  END
END

^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (160, CURRENT_TIMESTAMP);
COMMIT;
