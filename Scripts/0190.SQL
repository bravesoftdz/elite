/*
** CONTAS A RECEBER DE OS/VENDA ABERTO NAO DEVEM APARECER NO EXTRATO
*/

SET TERM ^ ;

ALTER PROCEDURE EXTRATO_DOC (
    DATAINI DATE,
    DATAFIM DATE,
    CODEMPRESA INTEGER)
RETURNS (
    DATAHORA TIMESTAMP,
    CLIENTE VARCHAR(40),
    DESCRICAO VARCHAR(40),
    VALORCRE NUMERIC(9,2),
    VALORDEB NUMERIC(9,2),
    LETRA CHAR(1),
    INFODOC VARCHAR(50),
    DOCUMENTO VARCHAR(40))
AS
DECLARE VARIABLE ES INTEGER;
DECLARE VARIABLE CONTADOR INTEGER;
BEGIN
  CONTADOR = 0;

  FOR
  SELECT
    PA.DATACADAST,
    PA.DESCRICAO,
    PA.VALOR,
    PA.ES,
    PA.INFODOC,
    CL.NOME,
    DC.DOCUMENTO
  FROM
    PAGAMENTOS PA
    LEFT JOIN CLIENTES CL ON
      (CL.CODIGO = PA.CODCLIENTE)
    LEFT JOIN DOCUMENTOS DC ON
      (DC.CODIGO = PA.CODDOCUMENTO)
  WHERE
    PA.PAGO = 0 AND
    CAST(PA.DATACADAST AS DATE) BETWEEN :DATAINI AND :DATAFIM AND
    PA.CODEMPRESA = :CODEMPRESA AND
    PA.ES IN (1, 2)
  ORDER BY
    DC.DOCUMENTO,
    PA.DATACADAST
  INTO
    :DATAHORA,
    :DESCRICAO,
    :VALORCRE,
    :ES,
    :INFODOC,
    :CLIENTE,
    :DOCUMENTO
  DO
  BEGIN

    CONTADOR = CONTADOR + 1;

    IF (ES = 1) THEN
     BEGIN
      LETRA = 'D';
      VALORDEB = VALORCRE;
      VALORCRE = NULL;
     END ELSE
     BEGIN
      LETRA = 'C';
      VALORDEB = NULL;
     END

    SUSPEND;

  END
END

^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (190, CURRENT_TIMESTAMP);
COMMIT;